!function(e){"use strict";"function"==typeof define&&define.amd?define(["jquery","./grid.base","./jquery.fmatter","./grid.common"],e):"object"==typeof module&&module.exports?module.exports=function(l,t){return l||(l=window),void 0===t&&(t="undefined"!=typeof window?require("jquery"):require("jquery")(l)),require("./grid.base"),require("./jquery.fmatter"),require("./grid.common"),e(t),t}:e(jQuery)}(function(e){"use strict";var l=e.jgrid,t=function(){var t=e.makeArray(arguments);return t.unshift(""),t.unshift(""),t.unshift(this.p),l.feedback.apply(this,t)},i=function(l,t){var i=this.grid.fbRows;return null!=(l=null!=i&&i[0].cells.length>t?i[l.rowIndex]:l)&&null!=l.cells?e(l.cells[t]):e()},r=function(e,l){var t=e.height();Math.abs(t-l)>=1&&l>0&&(e.height(l),t=e.height(),Math.abs(l-t)>=1&&e.height(l+Math.round(l-t)))};l.extend({editCell:function(a,n,o){return this.each(function(){var d,s,c,u,f=this,h=e(f),p=f.p,v=f.rows;if(f.grid&&!0===p.cellEdit&&null!=v&&null!=v[a]&&(a=parseInt(a,10),n=parseInt(n,10),!isNaN(a)&&!isNaN(n))){var C,m=v[a],g=null!=m?m.id:null,b=e(m),w=parseInt(p.iCol,10),j=parseInt(p.iRow,10),q=e(v[j]),G=p.savedRow;if(null!=g){if(p.selrow=g,p.knv||h.jqGrid("GridNav"),G.length>0&&q.length>0){if(!0===o&&a===j&&n===w)return;h.jqGrid("saveCell",G[0].id,G[0].ic)}else setTimeout(function(){e("#"+l.jqID(p.knv)).attr("tabindex","-1").focus()},1);if(u=p.colModel[n],"subgrid"!==(d=u.name)&&"cb"!==d&&"rn"!==d){c=i.call(f,m,n);var y=u.editable;e.isFunction(y)&&(y=y.call(f,{rowid:g,iCol:n,iRow:a,cmName:d,cm:u,mode:"cell"}));var x=h.jqGrid("getGuiStyles","states.select","edit-cell"),k=h.jqGrid("getGuiStyles","states.hover","selected-row");if(!0!==y||!0!==o||c.hasClass("not-editable-cell"))p.noCellSelection||(w>=0&&j>=0&&(i.call(f,q[0],w).removeClass(x),q.removeClass(k)),c.addClass(x),b.addClass(k)),s=c.html().replace(/&#160;/gi,""),t.call(f,"onSelectCell",g,d,s,a,n);else{p.noCellSelection||(w>=0&&j>=0&&(i.call(f,q[0],w).removeClass(x),q.removeClass(k)),c.addClass(x),b.addClass(k)),u.edittype||(u.edittype="text"),C=u.edittype;try{s=e.unformat.call(f,c,{rowId:g,colModel:u},n)}catch(e){s="textarea"===C?c.text():c.html()}if(p.autoEncodeOnEdit&&(s=l.oldDecodePostedData(s)),("&nbsp;"===s||"&#160;"===s||1===s.length&&160===s.charCodeAt(0))&&(s=""),e.isFunction(p.formatCell)){var E=p.formatCell.call(f,g,d,s,a,n);void 0!==E&&(s=E)}t.call(f,"beforeEditCell",g,d,s,a,n),G.push({id:a,ic:n,name:d,v:s}),p.editingInfo[g]={mode:"cellEditing",savedRow:G[G.length-1],editable:{}},p.editingInfo[g].editable[d]=y;var I=e.extend({},u.editoptions||{},{id:a+"_"+d,name:d,rowId:g,mode:"cell",cm:u,iCol:n}),R=l.createEl.call(f,C,I,s,!0,e.extend({},l.ajaxOptions,p.ajaxSelectOptions||{})),S=c,D=!0===p.treeGrid&&d===p.ExpandColumn;D&&(S=c.children("span.cell-wrapperleaf,span.cell-wrapper")),S.html("").append(R).attr("tabindex","0"),D&&e(R).width(c.width()-c.children("div.tree-wrap").outerWidth()),l.bindEv.call(f,R,I),p.frozenColumns&&n<h.jqGrid("getNumberOfFrozenColumns")&&r(e(f.rows[m.rowIndex].cells[n]),c.height()),setTimeout(function(){e(R).focus()},0),e("input, select, textarea",c).on("keydown",function(l){if(27===l.keyCode&&(e("input.hasDatepicker",c).length>0?e(".ui-datepicker").is(":hidden")?h.jqGrid("restoreCell",a,n):e("input.hasDatepicker",c).datepicker("hide"):h.jqGrid("restoreCell",a,n)),13===l.keyCode&&!l.shiftKey)return h.jqGrid("saveCell",a,n),!1;if(9===l.keyCode){if(f.grid.hDiv.loading)return!1;l.shiftKey?h.jqGrid("prevCell",a,n):h.jqGrid("nextCell",a,n)}l.stopPropagation()}),t.call(f,"afterEditCell",g,d,s,a,n)}p.iCol=n,p.iRow=a}}}})},saveCell:function(r,a){return this.each(function(){var n=this,o=e(n),d=n.p,s=n.grid,c=l.info_dialog,u=l.jqID;if(s&&!0===d.cellEdit){var f=o.jqGrid("getGridRes","errors"),h=f.errcap,p=o.jqGrid("getGridRes","edit").bClose,v=d.savedRow,C=v.length>=1?0:null;if(null!==C){var m,g=n.rows[r],b=null!=g?g.id:null,w=null!=g?e(g):e(),j=d.colModel[a],q=j.name,G=i.call(n,g,a),y={},x=l.getEditedValue.call(n,G,j,y);if(x!==v[C].v){void 0!==(m=o.triggerHandler("jqGridBeforeSaveCell",[b,q,x,r,a]))&&(x=m),e.isFunction(d.beforeSaveCell)&&void 0!==(m=d.beforeSaveCell.call(n,b,q,x,r,a))&&(x=m);var k=l.checkValues.call(n,x,a,void 0,void 0,{oldValue:v[C].v,newValue:x,cmName:q,rowid:b,iCol:a,iRow:r,cm:j,tr:g,td:G,mode:"cell"}),E=j.formatoptions||{};if(null==k||!0===k||!0===k[0]){var I=o.triggerHandler("jqGridBeforeSubmitCell",[b,q,x,r,a])||{};if(e.isFunction(d.beforeSubmitCell)&&((I=d.beforeSubmitCell.call(n,b,q,x,r,a))||(I={})),e("input.hasDatepicker",G).length>0&&e("input.hasDatepicker",G).datepicker("hide"),"date"===j.formatter&&!0!==E.sendFormatted&&(x=e.unformat.date.call(n,x,j)),"remote"===d.cellsubmit)if(d.cellurl){var R={};R[q]=x;var S=d.prmNames,D=S.id,F=S.oper;R[D]=l.stripPref(d.idPrefix,b),R[F]=S.editoper,R=e.extend(I,R),d.autoEncodeOnEdit&&e.each(R,function(t,i){e.isFunction(i)||(R[t]=l.oldEncodePostedData(i))}),o.jqGrid("progressBar",{method:"show",loadtype:d.loadui,htmlcontent:o.jqGrid("getGridRes","defaults.savetext")||"Saving..."}),s.hDiv.loading=!0,e.ajax(e.extend({url:e.isFunction(d.cellurl)?d.cellurl.call(n,d.cellurl,r,a,b,x,q):d.cellurl,data:l.serializeFeedback.call(n,d.serializeCellData,"jqGridSerializeCellData",R),type:"POST",complete:function(l){if(s.endReq.call(n),(l.status<300||304===l.status)&&(0!==l.status||4!==l.readyState)){var i=o.triggerHandler("jqGridAfterSubmitCell",[n,l,R.id,q,x,r,a])||[!0,""];(!0===i||!0===i[0]&&e.isFunction(d.afterSubmitCell))&&(i=d.afterSubmitCell.call(n,l,R.id,q,x,r,a)),null==i||!0===i||!0===i[0]?(o.jqGrid("setCell",b,a,x,!1,!1,!0),G.addClass("dirty-cell"),w.addClass("edited"),t.call(n,"afterSaveCell",b,q,x,r,a),v.splice(0,1),delete d.editingInfo[b]):(c.call(n,h,i[1],p),o.jqGrid("restoreCell",r,a))}},error:function(l,t,i){o.triggerHandler("jqGridErrorCell",[l,t,i]),e.isFunction(d.errorCell)?(d.errorCell.call(n,l,t,i),o.jqGrid("restoreCell",r,a)):(c.call(n,h,l.status+" : "+l.statusText+"<br/>"+t,p),o.jqGrid("restoreCell",r,a))}},l.ajaxOptions,d.ajaxCellOptions||{}))}else try{c.call(n,h,f.nourl,p),o.jqGrid("restoreCell",r,a)}catch(e){}if("clientArray"===d.cellsubmit){if(o.jqGrid("setCell",b,a,"select"===j.edittype&&"select"!==j.formatter?y.text:x,!1,!1,!0),G.addClass("dirty-cell"),w.addClass("edited"),t.call(n,"afterSaveCell",b,q,x,r,a),d.frozenColumns&&a<o.jqGrid("getNumberOfFrozenColumns"))try{n.rows[g.rowIndex].cells[a].style.height=""}catch(e){}v.splice(0,1),delete d.editingInfo[b]}}else try{setTimeout(function(){var t=l.getRelativeRect.call(n,G);c.call(n,h,x+" "+k[1],p,{top:t.top,left:t.left+e(n).closest(".ui-jqgrid").offset().left})},50),o.jqGrid("restoreCell",r,a)}catch(e){}}else o.jqGrid("restoreCell",r,a)}setTimeout(function(){e("#"+u(d.knv)).attr("tabindex","-1").focus()},0)}})},restoreCell:function(l,r){return this.each(function(){var a,n,o,d=this,s=d.p,c=d.rows[l],u=c.id;if(d.grid&&!0===s.cellEdit){var f=s.savedRow,h=i.call(d,c,r);if(f.length>=1){if(e.isFunction(e.fn.datepicker))try{e("input.hasDatepicker",h).datepicker("hide")}catch(e){}if(n=s.colModel[r],!0===s.treeGrid&&null!=n&&n.name===s.ExpandColumn?h.children("span.cell-wrapperleaf,span.cell-wrapper").empty():h.empty(),h.attr("tabindex","-1"),a=f[0].v,null!=n&&(o=n.formatoptions||{},"date"===n.formatter&&!0!==o.sendFormatted&&(a=e.unformat.date.call(d,a,n)),e(d).jqGrid("setCell",u,r,a,!1,!1,!0),s.frozenColumns&&r<e(d).jqGrid("getNumberOfFrozenColumns")))try{d.rows[c.rowIndex].cells[r].style.height=""}catch(e){}t.call(d,"afterRestoreCell",u,a,l,r),f.splice(0,1),delete s.editingInfo[u]}setTimeout(function(){e("#"+s.knv).attr("tabindex","-1").focus()},0)}})},nextCell:function(l,t){return this.each(function(){var i,r,a,n=this,o=e(n),d=n.p,s=!1,c=n.rows;if(n.grid&&!0===d.cellEdit&&null!=c&&null!=c[l]){for(i=t+1;i<d.colModel.length;i++)if(a=d.colModel[i],r=a.editable,e.isFunction(r)&&(r=r.call(n,{rowid:c[l].id,iCol:i,iRow:l,cmName:a.name,cm:a,mode:"cell"})),!0===r){s=i;break}!1!==s?o.jqGrid("editCell",l,s,!0):d.savedRow.length>0&&o.jqGrid("saveCell",l,t)}})},prevCell:function(l,t){return this.each(function(){var i,r,a,n=this,o=e(n),d=n.p,s=!1,c=n.rows;if(n.grid&&!0===d.cellEdit&&null!=c&&null!=c[l]){for(i=t-1;i>=0;i--)if(a=d.colModel[i],r=a.editable,e.isFunction(r)&&(r=r.call(n,{rowid:c[l].id,iCol:i,iRow:l,cmName:a.name,cm:a,mode:"cell"})),!0===r){s=i;break}!1!==s?o.jqGrid("editCell",l,s,!0):d.savedRow.length>0&&o.jqGrid("saveCell",l,t)}})},GridNav:function(){return this.each(function(){function l(e,l,t){var i=a.rows[e];if("v"===t.substr(0,1)){var r=s.clientHeight,n=s.scrollTop,o=i.offsetTop+i.clientHeight,d=i.offsetTop;"vd"===t&&o>=n+r&&(s.scrollTop=s.scrollTop+i.clientHeight),"vu"===t&&d<n&&(s.scrollTop=s.scrollTop-i.clientHeight)}if("h"===t){var c=s.clientWidth,u=s.scrollLeft,f=i.cells[l],h=f.offsetLeft+f.clientWidth,p=f.offsetLeft;h>=c+parseInt(u,10)?s.scrollLeft=s.scrollLeft+f.clientWidth:p<u&&(s.scrollLeft=s.scrollLeft-f.clientWidth)}}function t(e,l){var t,i=0,r=o.colModel;if("lft"===l)for(i=e+1,t=e;t>=0;t--)if(!0!==r[t].hidden){i=t;break}if("rgt"===l)for(i=e-1,t=e;t<r.length;t++)if(!0!==r[t].hidden){i=t;break}return i}var i,r,a=this,n=e(a),o=a.p,d=a.grid;if(d&&!0===o.cellEdit){var s=d.bDiv;o.knv=o.id+"_kn";var c=e("<div style='position:fixed;top:0px;width:1px;height:1px;' tabindex='0'><div tabindex='-1' style='width:1px;height:1px;' id='"+o.knv+"'></div></div>");e(c).insertBefore(d.cDiv),e("#"+o.knv).focus().keydown(function(e){var d=parseInt(o.iRow,10),s=parseInt(o.iCol,10);switch(r=e.keyCode,"rtl"===o.direction&&(37===r?r=39:39===r&&(r=37)),r){case 38:d-1>0&&(l(d-1,s,"vu"),n.jqGrid("editCell",d-1,s,!1));break;case 40:d+1<=a.rows.length-1&&(l(d+1,s,"vd"),n.jqGrid("editCell",d+1,s,!1));break;case 37:s-1>=0&&(l(d,i=t(s-1,"lft"),"h"),n.jqGrid("editCell",d,i,!1));break;case 39:s+1<=o.colModel.length-1&&(l(d,i=t(s+1,"rgt"),"h"),n.jqGrid("editCell",d,i,!1));break;case 13:s>=0&&d>=0&&n.jqGrid("editCell",d,s,!0);break;default:return!0}return!1})}})},getChangedCells:function(t){var r=[];return t||(t="all"),this.each(function(){var a=this,n=a.p,o=l.htmlDecode,d=a.rows;a.grid&&!0===n.cellEdit&&e(d).each(function(l){var s={};if(e(this).hasClass("edited")){var c=this;e(this.cells).each(function(r){var u=n.colModel[r],f=u.name,h=i.call(a,c,r);if("cb"!==f&&"subgrid"!==f&&"rn"!==f&&("dirty"!==t||h.hasClass("dirty-cell")))try{s[f]=e.unformat.call(a,h[0],{rowId:d[l].id,colModel:u},r)}catch(e){s[f]=o(h.html())}}),s.id=this.id,r.push(s)}})}),r}})});
//# sourceMappingURL=grid.celledit.js.map